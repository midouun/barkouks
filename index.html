<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù…Ù„ÙƒÙŠØ©</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #795548;
            --accent: #8bc34a;
            --bg: #f1f8e9;
            --soil: #5d4037;
            --water: #29b6f6;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            margin: 0;
            user-select: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- 1. Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø§Ù„Ù…ÙˆØ§Ø±Ø¯) --- */
        .top-bar {
            background: #fff;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .user-chip {
            display: flex;
            align-items: center;
            background: #eee;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
        }
        .user-chip img { width: 24px; height: 24px; border-radius: 50%; margin-left: 5px; }
        .resources { display: flex; gap: 15px; font-weight: bold; color: #333; }
        .res-item span { color: #f39c12; margin-left: 2px; }

        /* --- 2. Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨ (Ø§Ù„Ø­Ù‚Ù„) --- */
        .game-world {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-image: radial-gradient(#a5d6a7 10%, transparent 10%);
            background-size: 20px 20px;
        }

        .section-title { font-size: 18px; margin-bottom: 10px; color: var(--primary); font-weight: bold; }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø±Ø¶ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ© */
        .farm-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }
        .plot {
            aspect-ratio: 1;
            background-color: var(--soil);
            border-radius: 8px;
            border: 4px solid #4e342e;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .plot.ready { border-color: gold; animation: pulse 1s infinite; }
        .crop-icon { font-size: 40px; }
        .timer-bar {
            position: absolute;
            bottom: 5px;
            left: 5px;
            right: 5px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }
        .timer-fill { height: 100%; background: var(--accent); width: 0%; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }

        /* Ø§Ù„Ø­Ø¸ÙŠØ±Ø© */
        .barn-section {
            background: #fff8e1;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            border: 2px dashed #ffb74d;
        }
        .cow-btn { font-size: 60px; cursor: pointer; transition: transform 0.1s; display: inline-block; }
        .cow-btn:active { transform: scale(0.9); }

        /* --- 3. Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø³ÙÙ„ÙŠØ© (Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†) --- */
        .bottom-panel {
            background: white;
            border-top: 1px solid #ddd;
            height: 220px;
            display: flex;
            flex-direction: column;
        }
        .tabs { display: flex; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #f9f9f9; }
        .tab.active { background: #fff; font-weight: bold; border-bottom: 3px solid var(--accent); color: var(--accent); }
        
        .panel-content { flex: 1; overflow-y: auto; padding: 10px; }
        .shop-item, .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-sell { background: #e67e22; }

        /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø°ÙˆØ± */
        .seed-selector {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        .seed-modal {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            text-align: center;
        }
        .seed-option {
            background: #f0f0f0;
            margin: 5px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }

    </style>
</head>
<body>

    <div class="top-bar">
        <div class="user-chip">
            <img id="u_photo" src="" alt="">
            <span id="u_name">Ù„Ø§Ø¹Ø¨</span>
        </div>
        <div class="resources">
            <div class="res-item">ğŸ’° <span id="money">0</span></div>
            <div class="res-item">â­ <span id="xp">0</span></div>
        </div>
    </div>

    <div class="game-world">
        <div class="section-title">ğŸŒ± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ©</div>
        <div class="farm-grid" id="farmGrid">
            </div>

        <div class="section-title">ğŸ® Ø§Ù„Ø­Ø¸ÙŠØ±Ø©</div>
        <div class="barn-section">
            <div class="cow-btn" onclick="Game.milkCow()">ğŸ„</div>
            <p>Ù„Ø¯ÙŠÙƒ <span id="milk_storage">0</span> Ù„ØªØ± Ø­Ù„ÙŠØ¨</p>
        </div>
    </div>

    <div class="bottom-panel">
        <div class="tabs">
            <div class="tab active" onclick="UI.switchTab('shop')">ğŸª Ø§Ù„Ù…ØªØ¬Ø±</div>
            <div class="tab" onclick="UI.switchTab('inventory')">ğŸ’ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
        </div>
        
        <div id="tab-shop" class="panel-content">
            </div>

        <div id="tab-inventory" class="panel-content" style="display:none;">
            </div>
    </div>

    <div class="seed-selector" id="seedModal" onclick="this.style.display='none'">
        <div class="seed-modal" onclick="event.stopPropagation()">
            <h3>Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªØ²Ø±Ø¹ØŸ</h3>
            <div id="seedList"></div>
        </div>
    </div>

    <script>
        // === 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© (CONSTANTS) ===
        const CROPS_DATA = {
            'carrot': { name: 'Ø¬Ø²Ø±', icon: 'ğŸ¥•', cost: 10, sell: 15, growthTime: 5000 }, // 5 Ø«ÙˆØ§Ù†ÙŠ
            'corn': { name: 'Ø°Ø±Ø©', icon: 'ğŸŒ½', cost: 25, sell: 40, growthTime: 10000 }, // 10 Ø«ÙˆØ§Ù†ÙŠ
            'tomato': { name: 'Ø·Ù…Ø§Ø·Ù…', icon: 'ğŸ…', cost: 50, sell: 90, growthTime: 20000 } // 20 Ø«Ø§Ù†ÙŠØ©
        };

        // === 2. Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (GAME STATE) ===
        let State = {
            money: 100, // Ø¨Ø¯Ø§ÙŠØ© Ø¨Ù€ 100 Ø¯ÙŠÙ†Ø§Ø±
            xp: 0,
            milk: 0,
            seeds: { 'carrot': 2, 'corn': 0, 'tomato': 0 }, // Ø¨Ø°ÙˆØ± Ù…Ø¬Ø§Ù†ÙŠØ©
            crops: { 'carrot': 0, 'corn': 0, 'tomato': 0 },
            plots: [ // 6 Ù‚Ø·Ø¹ Ø£Ø±Ø§Ø¶ÙŠ
                { id: 0, status: 'empty', crop: null, plantTime: 0 },
                { id: 1, status: 'empty', crop: null, plantTime: 0 },
                { id: 2, status: 'empty', crop: null, plantTime: 0 },
                { id: 3, status: 'locked', crop: null, plantTime: 0 }, // Ù…Ù‚ÙÙ„Ø© Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
                { id: 4, status: 'locked', crop: null, plantTime: 0 },
                { id: 5, status: 'locked', crop: null, plantTime: 0 }
            ]
        };

        // === 3. Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© (GAME LOGIC) ===
        const Game = {
            init: function() {
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const saved = localStorage.getItem('RealFarm_v1');
                if (saved) State = JSON.parse(saved);

                // Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙ„ÙŠØ¬Ø±Ø§Ù…
                const tg = window.Telegram.WebApp;
                tg.expand();
                const user = tg.initDataUnsafe.user;
                if(user) {
                    document.getElementById('u_name').innerText = user.first_name;
                    document.getElementById('u_photo').src = user.photo_url || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
                }

                // Ø¨Ø¯Ø¡ Ø­Ù„Ù‚Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« (Game Loop)
                setInterval(() => {
                    UI.renderPlots();
                    Game.save();
                }, 1000);

                UI.renderShop();
                UI.renderInventory();
                UI.updateHeader();
            },

            save: function() {
                localStorage.setItem('RealFarm_v1', JSON.stringify(State));
            },

            buySeed: function(type) {
                const cost = CROPS_DATA[type].cost;
                if (State.money >= cost) {
                    State.money -= cost;
                    State.seeds[type]++;
                    UI.updateHeader();
                    UI.renderShop(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                    window.Telegram.WebApp.HapticFeedback.selectionChanged();
                } else {
                    window.Telegram.WebApp.showAlert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ù…Ø§Ù„ ÙƒØ§ÙÙ! Ø¨Ø¹ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø­Ø§ØµÙŠÙ„.");
                }
            },

            plant: function(plotIndex, cropType) {
                if (State.seeds[cropType] > 0) {
                    State.seeds[cropType]--;
                    State.plots[plotIndex].status = 'growing';
                    State.plots[plotIndex].crop = cropType;
                    State.plots[plotIndex].plantTime = Date.now(); // ÙˆÙ‚Øª Ø§Ù„Ø²Ø±Ø§Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ
                    
                    document.getElementById('seedModal').style.display = 'none';
                    UI.renderPlots();
                    UI.renderShop(); // Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø°ÙˆØ±
                }
            },

            harvest: function(plotIndex) {
                const plot = State.plots[plotIndex];
                if (plot.status === 'ready') {
                    // Ø§Ù„Ø­ØµØ§Ø¯
                    State.crops[plot.crop]++;
                    State.xp += 5;
                    
                    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø±Ø¶
                    plot.status = 'empty';
                    plot.crop = null;
                    plot.plantTime = 0;

                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    UI.renderInventory();
                    UI.updateHeader();
                    UI.renderPlots();
                }
            },

            sellCrop: function(type) {
                if (State.crops[type] > 0) {
                    State.crops[type]--;
                    State.money += CROPS_DATA[type].sell;
                    UI.updateHeader();
                    UI.renderInventory();
                    window.Telegram.WebApp.HapticFeedback.selectionChanged();
                }
            },

            sellMilk: function() {
                if(State.milk >= 1) {
                    State.money += Math.floor(State.milk) * 5;
                    State.milk = 0;
                    UI.updateHeader();
                    document.getElementById('milk_storage').innerText = "0";
                }
            },

            milkCow: function() {
                State.milk += 1;
                document.getElementById('milk_storage').innerText = State.milk;
                window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
        };

        // === 4. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UI) ===
        const UI = {
            updateHeader: function() {
                document.getElementById('money').innerText = State.money;
                document.getElementById('xp').innerText = State.xp;
                document.getElementById('milk_storage').innerText = State.milk;
            },

            renderPlots: function() {
                const grid = document.getElementById('farmGrid');
                grid.innerHTML = '';

                State.plots.forEach((plot, index) => {
                    if (plot.status === 'locked') return; // Ù„Ø§ ØªØ¹Ø±Ø¶ Ø§Ù„Ù…Ù‚ÙÙ„ Ø§Ù„Ø¢Ù†

                    const el = document.createElement('div');
                    el.className = 'plot';
                    
                    if (plot.status === 'empty') {
                        el.innerHTML = '<span style="opacity:0.3; font-size:20px;">ğŸŒ±</span>';
                        el.onclick = () => UI.openSeedModal(index);
                    } 
                    else if (plot.status === 'growing') {
                        const cropInfo = CROPS_DATA[plot.crop];
                        const timePassed = Date.now() - plot.plantTime;
                        const progress = Math.min((timePassed / cropInfo.growthTime) * 100, 100);

                        if (progress >= 100) {
                            plot.status = 'ready'; // ØªØ­ÙˆÙ„ Ù„Ù„Ø­ØµØ§Ø¯
                        }

                        el.innerHTML = `
                            <div class="crop-icon" style="opacity: ${0.5 + (progress/200)}">${cropInfo.icon}</div>
                            <div class="timer-bar" style="display:block">
                                <div class="timer-fill" style="width:${progress}%"></div>
                            </div>
                        `;
                    }
                    else if (plot.status === 'ready') {
                        el.className += ' ready';
                        el.innerHTML = `<div class="crop-icon">${CROPS_DATA[plot.crop].icon}</div>`;
                        el.onclick = () => Game.harvest(index);
                    }

                    grid.appendChild(el);
                });
            },

            openSeedModal: function(plotIndex) {
                const modal = document.getElementById('seedModal');
                const list = document.getElementById('seedList');
                list.innerHTML = '';

                // Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø°ÙˆØ± Ø§Ù„Ù…ØªÙˆÙØ±Ø© ÙÙ‚Ø·
                let hasSeeds = false;
                for (let [type, count] of Object.entries(State.seeds)) {
                    if (count > 0) {
                        hasSeeds = true;
                        const item = document.createElement('div');
                        item.className = 'seed-option';
                        item.innerHTML = `<span>${CROPS_DATA[type].icon} ${CROPS_DATA[type].name}</span> <span>x${count}</span>`;
                        item.onclick = () => Game.plant(plotIndex, type);
                        list.appendChild(item);
                    }
                }

                if (!hasSeeds) {
                    list.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø°ÙˆØ±! Ø§Ø´ØªØ±Ù Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±.</p>';
                }

                modal.style.display = 'flex';
            },

            renderShop: function() {
                const container = document.getElementById('tab-shop');
                container.innerHTML = '';
                
                // Ø²Ø± Ø¨ÙŠØ¹ Ø§Ù„Ø­Ù„ÙŠØ¨
                const milkDiv = document.createElement('div');
                milkDiv.className = 'shop-item';
                milkDiv.innerHTML = `
                    <span>ğŸ¥› Ø¨ÙŠØ¹ Ø§Ù„Ø­Ù„ÙŠØ¨ Ø§Ù„Ù…Ø®Ø²Ù†</span>
                    <button class="btn btn-sell" onclick="Game.sellMilk()">Ø¨ÙŠØ¹ Ø§Ù„ÙƒÙ„</button>
                `;
                container.appendChild(milkDiv);

                // Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¨Ø°ÙˆØ±
                for (let [key, data] of Object.entries(CROPS_DATA)) {
                    const item = document.createElement('div');
                    item.className = 'shop-item';
                    item.innerHTML = `
                        <div>${data.icon} Ø¨Ø°ÙˆØ± ${data.name} <small>(${State.seeds[key]} Ù„Ø¯ÙŠÙƒ)</small></div>
                        <button class="btn" onclick="Game.buySeed('${key}')">${data.cost}ğŸ’°</button>
                    `;
                    container.appendChild(item);
                }
            },

            renderInventory: function() {
                const container = document.getElementById('tab-inventory');
                container.innerHTML = '';

                let isEmpty = true;
                for (let [key, count] of Object.entries(State.crops)) {
                    if (count > 0) {
                        isEmpty = false;
                        const item = document.createElement('div');
                        item.className = 'inventory-item';
                        item.innerHTML = `
                            <div>${CROPS_DATA[key].icon} ${CROPS_DATA[key].name} (x${count})</div>
                            <button class="btn btn-sell" onclick="Game.sellCrop('${key}')">Ø¨ÙŠØ¹ ${CROPS_DATA[key].sell}ğŸ’°</button>
                        `;
                        container.appendChild(item);
                    }
                }
                if (isEmpty) container.innerHTML = '<p style="text-align:center; color:#999;">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙØ§Ø±Øº. Ø§Ø²Ø±Ø¹ ÙˆØ§Ø­ØµØ¯!</p>';
            },

            switchTab: function(tabName) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel-content').forEach(c => c.style.display = 'none');
                
                event.target.classList.add('active');
                document.getElementById('tab-' + tabName).style.display = 'block';
                
                if(tabName === 'shop') UI.renderShop();
                if(tabName === 'inventory') UI.renderInventory();
            }
        };

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©
        Game.init();

    </script>
</body>
</html>
