<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø²Ø±Ø¹ØªÙŠ Ø§Ù„Ø³Ø¹ÙŠØ¯Ø©</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --header-bg: #ffffff;
            --accent: #27ae60;
            --text-main: #2c3e50;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* 1. Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ (Ø§Ù„Ø£Ø¹Ù„Ù‰) */
        .user-profile {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            padding: 15px;
            display: flex;
            align-items: center;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid white;
            margin-left: 10px;
            background-color: #ddd;
            object-fit: cover;
        }
        .user-info h3 { margin: 0; font-size: 16px; }
        .user-info p { margin: 0; font-size: 12px; opacity: 0.9; }

        /* 2. Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ */
        .resources-bar {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 10px;
            margin: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-weight: bold;
        }

        /* 3. Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ù…ØªØºÙŠØ±Ø©) */
        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex; /* Ø¬Ø¹Ù„Ù†Ø§Ù‡Ø§ Ù…Ø±Ù†Ø© Ù„ØªÙˆØ³ÙŠØ· Ø§Ù„Ø¹Ù†Ø§ØµØ± */
            justify-content: center;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ø¸ÙŠØ±Ø© */
        .barn-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .cow-img {
            width: 280px;
            transition: transform 0.1s;
            cursor: pointer;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.2));
        }
        .cow-img:active { transform: scale(0.95); }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† */
        .leaderboard-list {
            width: 100%;
            background: white;
            border-radius: 10px;
            padding: 10px;
        }
        .leader-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .rank { font-weight: bold; width: 30px; color: var(--accent); }
        .player-img { width: 40px; height: 40px; border-radius: 50%; margin-left: 10px; background: #eee; }
        .player-name { flex-grow: 1; font-size: 14px; }
        .player-score { font-weight: bold; color: #f39c12; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø³ÙˆÙ‚ */
        .market-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            width: 90%;
            margin-bottom: 10px;
        }
        .btn-sell {
            background: #e67e22;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav {
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #eee;
        }
        .nav-item {
            text-align: center;
            font-size: 12px;
            color: #95a5a6;
            cursor: pointer;
            flex: 1;
        }
        .nav-item.active { color: var(--accent); font-weight: bold; }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 4px; }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© */
        .floating-text {
            position: absolute;
            font-weight: bold;
            font-size: 24px;
            color: var(--accent);
            pointer-events: none;
            animation: floatUp 0.8s forwards;
            z-index: 100;
        }
        @keyframes floatUp { to { transform: translateY(-80px); opacity: 0; } }

        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø§Øª ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·Ø© */
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div class="user-profile">
        <img id="userPhoto" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="user-avatar" alt="User">
        <div class="user-info">
            <h3 id="userName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
            <p>Ù…Ø²Ø§Ø±Ø¹ Ù…Ø¨ØªØ¯Ø¦</p>
        </div>
    </div>

    <div class="resources-bar">
        <div>ğŸ¥› <span id="milkDisplay">0</span> Ù„ØªØ±</div>
        <div>ğŸ’° <span id="moneyDisplay">0</span> Ø¯.Ø¬</div>
    </div>

    <div class="content-area">
        
        <div id="page-barn" class="barn-stage">
            <h2 style="color: #7f8c8d; margin-bottom: 20px;">Ø§Ø¶ØºØ· Ù„Ù„Ø­Ù„Ø¨</h2>
            <img src="https://cdn-icons-png.flaticon.com/512/2674/2674067.png" class="cow-img" id="cowBtn" alt="Cow">
        </div>

        <div id="page-market" class="barn-stage hidden">
            <div class="market-card">
                <h2>ğŸª Ø³ÙˆÙ‚ Ø§Ù„Ø¬Ù…Ù„Ø©</h2>
                <p>Ø³Ø¹Ø± Ø§Ù„Ø­Ù„ÙŠØ¨ Ø§Ù„ÙŠÙˆÙ…: <strong>10 Ø¯.Ø¬ / Ù„ØªØ±</strong></p>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                <p>Ù„Ø¯ÙŠÙƒ: <span id="milkInMarket">0</span> Ù„ØªØ±</p>
                <button class="btn-sell" onclick="sellAllMilk()">Ø¨ÙŠØ¹ Ø§Ù„ÙƒÙ„ ğŸ’°</button>
            </div>
        </div>

        <div id="page-rank" class="leaderboard-list hidden">
            <h3 style="text-align: center;">ğŸ† ÙƒØ¨Ø§Ø± Ø§Ù„ÙÙ„Ø§Ø­ÙŠÙ†</h3>
            <div id="leaderboardContainer">
                </div>
        </div>

    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('barn', this)">
            <span class="nav-icon">ğŸ®</span>Ø§Ù„Ø­Ø¸ÙŠØ±Ø©
        </div>
        <div class="nav-item" onclick="switchTab('market', this)">
            <span class="nav-icon">ğŸª</span>Ø§Ù„Ø³ÙˆÙ‚
        </div>
        <div class="nav-item" onclick="switchTab('rank', this)">
            <span class="nav-icon">ğŸ†</span>Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† ØªÙ„ÙŠØ¬Ø±Ø§Ù…
        const user = tg.initDataUnsafe.user || { first_name: "Ù…Ø²Ø§Ø±Ø¹", last_name: "Ø¶ÙŠÙ", photo_url: null };
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
        document.getElementById('userName').innerText = `${user.first_name} ${user.last_name || ''}`;
        if (user.photo_url) {
            document.getElementById('userPhoto').src = user.photo_url;
        }

        // 2. Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        let gameState = {
            milk: 0,
            money: 0,
            xp: 0
        };

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­ÙØ¸
        if (localStorage.getItem('farm_v3')) {
            gameState = JSON.parse(localStorage.getItem('farm_v3'));
        }

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        function updateUI() {
            document.getElementById('milkDisplay').innerText = gameState.milk.toFixed(1);
            document.getElementById('moneyDisplay').innerText = Math.floor(gameState.money);
            document.getElementById('milkInMarket').innerText = gameState.milk.toFixed(1);
        }

        function saveGame() {
            localStorage.setItem('farm_v3', JSON.stringify(gameState));
        }

        // 4. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ù„Ø¨
        document.getElementById('cowBtn').addEventListener('click', (e) => {
            gameState.milk += 1;
            tg.HapticFeedback.impactOccurred('light');
            
            // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ
            const floatEl = document.createElement('div');
            floatEl.className = 'floating-text';
            floatEl.innerText = '+1 ğŸ¥›';
            floatEl.style.left = e.clientX + 'px';
            floatEl.style.top = e.clientY + 'px';
            document.body.appendChild(floatEl);
            setTimeout(() => floatEl.remove(), 800);

            saveGame();
            updateUI();
        });

        // 5. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³ÙˆÙ‚ (Ø¨ÙŠØ¹ Ø§Ù„Ø­Ù„ÙŠØ¨)
        function sellAllMilk() {
            if (gameState.milk >= 1) {
                let earnings = Math.floor(gameState.milk) * 10; // Ø§Ù„Ø³Ø¹Ø± 10
                gameState.money += earnings;
                gameState.milk = gameState.milk % 1; // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ÙƒØ³ÙˆØ± ÙÙ‚Ø·
                
                tg.HapticFeedback.notificationOccurred('success');
                alert(`ØªÙ… Ø¨ÙŠØ¹ Ø§Ù„Ø­Ù„ÙŠØ¨ Ù…Ù‚Ø§Ø¨Ù„ ${earnings} Ø¯.Ø¬!`);
                saveGame();
                updateUI();
            } else {
                tg.showAlert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ù„ÙŠØ¨ ÙƒØ§ÙÙ Ù„Ù„Ø¨ÙŠØ¹!");
            }
        }

        // 6. Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† (ÙˆÙ‡Ù…ÙŠ Ù„Ù„Ø¹Ø±Ø¶)
        function renderLeaderboard() {
            const list = document.getElementById('leaderboardContainer');
            list.innerHTML = '';
            
            // Ù‚Ø§Ø¦Ù…Ø© ÙˆÙ‡Ù…ÙŠØ© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´ÙƒÙ„
            const fakePlayers = [
                { name: "Ø¹Ù„ÙŠ Ø§Ù„ÙÙ„Ø§Ø­", score: 5000, img: "https://cdn-icons-png.flaticon.com/512/3135/3135715.png" },
                { name: "Sami Dz", score: 3400, img: "https://cdn-icons-png.flaticon.com/512/3135/3135768.png" },
                { name: `${user.first_name} (Ø£Ù†Øª)`, score: Math.floor(gameState.money), img: user.photo_url || "https://cdn-icons-png.flaticon.com/512/149/149071.png", isMe: true },
                { name: "Bot Farmer", score: 120, img: "https://cdn-icons-png.flaticon.com/512/4712/4712109.png" }
            ];

            // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
            fakePlayers.sort((a, b) => b.score - a.score);

            fakePlayers.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = 'leader-item';
                if(player.isMe) item.style.backgroundColor = "#e8f8f5"; // ØªÙ…ÙŠÙŠØ² Ø­Ø³Ø§Ø¨ÙŠ

                item.innerHTML = `
                    <div class="rank">#${index + 1}</div>
                    <img src="${player.img}" class="player-img">
                    <div class="player-name">${player.name}</div>
                    <div class="player-score">${player.score} ğŸ’°</div>
                `;
                list.appendChild(item);
            });
        }

        // 7. Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
        window.switchTab = function(tabName, btnElement) {
            // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª
            document.getElementById('page-barn').classList.add('hidden');
            document.getElementById('page-market').classList.add('hidden');
            document.getElementById('page-rank').classList.add('hidden');

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            document.getElementById(`page-${tabName}`).classList.remove('hidden');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            btnElement.classList.add('active');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙƒÙ„ ØµÙØ­Ø©
            if(tabName === 'rank') renderLeaderboard();
            updateUI();
        }

        // Ø§Ù„Ø¨Ø¯Ø¡
        updateUI();

    </script>
</body>
</html>
