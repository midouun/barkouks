<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù‡Ø§ÙŠ Ø¯Ø§ÙŠ ØªÙ„ÙŠØ¬Ø±Ø§Ù… ğŸšœ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Changa:wght@400;700&display=swap');

        :root {
            --grass-light: #8DCF56;
            --grass-dark: #7DBF46;
            --sky: #AEE6F8;
        }

        body {
            font-family: 'Changa', sans-serif;
            background-color: var(--sky);
            margin: 0;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* --- Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„Ø¹Ø§Ù„Ù… --- */
        .world-container {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.2) 0%, transparent 60%), linear-gradient(to bottom, #AEE6F8 0%, #8DCF56 40%);
        }

        .iso-grid {
            transform: rotateX(60deg) rotateZ(-45deg);
            transform-style: preserve-3d;
            display: grid;
            grid-template-columns: repeat(6, 60px);
            grid-template-rows: repeat(6, 60px);
            gap: 4px;
            padding: 100px;
        }

        /* --- Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª (Tiles) --- */
        .tile {
            width: 60px; height: 60px;
            background-color: var(--grass-light);
            border: 4px solid var(--grass-dark);
            border-radius: 4px;
            position: relative;
            transition: transform 0.1s;
            cursor: pointer;
            box-shadow: -4px 4px 0px rgba(0,0,0,0.2);
        }
        .tile:active { transform: translate(-2px, 2px); box-shadow: -2px 2px 0px rgba(0,0,0,0.2); }
        
        .tile.farmland { background-color: #6D4C41; border-color: #4E342E; }
        .tile.coop { background-color: #FFCC80; border-color: #EF6C00; } /* Ø´ÙƒÙ„ Ù‚Ù† Ø§Ù„Ø¯Ø¬Ø§Ø¬ */
        
        /* Ø§Ù„Ù…Ø­Ø§ØµÙŠÙ„ ÙˆØ§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª */
        .sprite {
            position: absolute;
            top: -40px; left: -10px;
            width: 80px; height: 80px;
            pointer-events: none;
            transform: rotateZ(45deg) rotateX(-60deg);
            display: flex; justify-content: center; align-items: flex-end;
            font-size: 40px;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
            transition: transform 0.3s;
        }

        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
        .growing .sprite { transform: rotateZ(45deg) rotateX(-60deg) scale(0.6); opacity: 0.9; }
        .ready .sprite { animation: bounce 1s infinite; cursor: grab; }
        @keyframes bounce {
            0%, 100% { transform: rotateZ(45deg) rotateX(-60deg) translateY(0); }
            50% { transform: rotateZ(45deg) rotateX(-60deg) translateY(-10px); }
        }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… --- */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .header-wood {
            pointer-events: auto;
            background: url('https://www.transparenttextures.com/patterns/wood-pattern.png'), linear-gradient(to bottom, #E4A656, #A05E23);
            border-bottom: 4px solid #5D4037;
            padding: 10px;
            display: flex; justify-content: space-between; align-items: center;
            color: white;
            text-shadow: 1px 1px 2px #3E2723;
        }
        
        .xp-bar-container { width: 100px; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; border: 1px solid white; }
        .xp-fill { height: 100%; background: #00E676; width: 0%; transition: width 0.5s; }

        .action-dock {
            pointer-events: auto;
            display: flex; justify-content: center; gap: 15px; padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
        }

        .tool-btn {
            width: 70px; height: 70px;
            background: radial-gradient(circle, #fff, #f0f0f0);
            border: 4px solid white; border-radius: 50%;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
            font-size: 32px; cursor: pointer; position: relative;
        }
        .badge { position: absolute; top: 0; right: 0; background: red; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: bold; }

        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 100; display: none; justify-content: center; align-items: center; pointer-events: auto;
        }
        
        .wood-panel {
            background: url('https://www.transparenttextures.com/patterns/wood-pattern.png'), #D7CCC8;
            border: 6px solid #8D6E63; border-radius: 20px; padding: 20px;
            width: 85%; max-width: 400px; text-align: center; position: relative;
        }
        .close-btn {
            position: absolute; top: -15px; right: -15px; width: 35px; height: 35px;
            background: #e53935; color: white; border-radius: 50%; border: 3px solid white;
            display: flex; justify-content: center; align-items: center; cursor: pointer; font-weight: bold;
        }

        .floater {
            position: absolute; font-weight: bold; font-size: 18px; color: yellow;
            text-shadow: 0 2px 4px black; animation: floatUp 1s forwards; pointer-events: none; z-index: 200;
        }
        @keyframes floatUp { to { transform: translateY(-80px); opacity: 0; } }
    </style>
</head>
<body>

    <div class="world-container" id="world">
        <div class="iso-grid" id="grid"></div>
    </div>

    <div class="ui-layer">
        <div class="header-wood">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="background:#3E2723; border:2px solid #A1887F; width:45px; height:45px; border-radius:10px; display:flex; justify-content:center; align-items:center; font-weight:bold; font-size:20px;">
                    <span id="level">1</span>
                </div>
                <div>
                    <div id="u_name" style="font-weight:bold;">Ù…Ø²Ø§Ø±Ø¹</div>
                    <div class="xp-bar-container"><div class="xp-fill" id="xp-bar"></div></div>
                </div>
            </div>
            
            <div style="text-align:left;">
                <div style="background:#FFF8E1; color:#3E2723; padding:5px 10px; border-radius:20px; font-weight:bold;">ğŸ’° <span id="coins">100</span></div>
                <div style="background:#E0F7FA; color:#006064; padding:5px 10px; border-radius:20px; font-weight:bold; margin-top:5px; font-size:12px;">ğŸ’ <span id="gems">5</span></div>
            </div>
        </div>

        <div class="action-dock">
            <div class="tool-btn" onclick="UI.openModal('shop')">ğŸª</div>
            <div class="tool-btn" onclick="UI.openModal('silo')">ğŸ›– <span class="badge" id="silo-count">0</span></div>
            <div class="tool-btn" onclick="UI.openModal('barn')">ğŸ˜ï¸ <span class="badge" id="barn-count">0</span></div>
            <div class="tool-btn" onclick="UI.openModal('orders')">ğŸšš <span class="badge">!</span></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-silo"><div class="wood-panel"><div class="close-btn" onclick="UI.closeAll()">X</div><h2>ğŸŒ± Ø§Ù„Ø¨Ø°ÙˆØ±</h2><div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;" id="silo-grid"></div></div></div>
    <div class="modal-overlay" id="modal-barn"><div class="wood-panel"><div class="close-btn" onclick="UI.closeAll()">X</div><h2>ğŸ¥– Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2><div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;" id="barn-grid"></div></div></div>
    <div class="modal-overlay" id="modal-orders"><div class="wood-panel"><div class="close-btn" onclick="UI.closeAll()">X</div><h2>ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2><div id="orders-list"></div></div></div>
    
    <div class="modal-overlay" id="modal-shop">
        <div class="wood-panel">
            <div class="close-btn" onclick="UI.closeAll()">X</div>
            <h2>ğŸ—ï¸ Ø§Ù„Ù…ØªØ¬Ø±</h2>
            <div style="background:#FFF3E0; padding:10px; margin:5px; border-radius:10px; cursor:pointer;" onclick="Game.buyPlot()">
                ğŸŸ« Ø´Ø±Ø§Ø¡ Ø£Ø±Ø¶ Ø²Ø±Ø§Ø¹ÙŠØ© (50 ğŸ’°)
            </div>
            <div style="background:#FFF3E0; padding:10px; margin:5px; border-radius:10px; cursor:pointer;" onclick="Game.buyCoop()">
                ğŸ›– Ø´Ø±Ø§Ø¡ Ù‚Ù† Ø¯Ø¬Ø§Ø¬ (100 ğŸ’°)
            </div>
            <div style="margin-top:20px;"><div id="ton-connect-btn"></div></div>
        </div>
    </div>

    <div id="current-tool-display" style="position:absolute; bottom:120px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); color:white; padding:5px 15px; border-radius:20px; pointer-events:none; display:none;">
        Ø§Ù„Ø£Ø¯Ø§Ø©: <span id="tool-name">ÙŠØ¯</span>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ===
        const CONFIG = {
            crops: {
                'wheat': { name: 'Ù‚Ù…Ø­', icon: 'ğŸŒ¾', time: 3000, xp: 2, sell: 5 },
                'corn': { name: 'Ø°Ø±Ø©', icon: 'ğŸŒ½', time: 6000, xp: 4, sell: 12 },
                'carrot': { name: 'Ø¬Ø²Ø±', icon: 'ğŸ¥•', time: 10000, xp: 6, sell: 18 }
            },
            animals: {
                'chicken': { name: 'Ø¯Ø¬Ø§Ø¬', icon: 'ğŸ”', product: 'egg', feed: 'wheat', time: 5000, xp: 5 }
            }
        };

        // === Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ===
        let state = {
            coins: 100, gems: 5, level: 1, xp: 0, maxXp: 50,
            inventory: { 'wheat': 5, 'corn': 2, 'carrot': 0, 'egg': 0 }, // Ø£Ø¶ÙÙ†Ø§ Ø§Ù„Ø¨ÙŠØ¶
            grid: [
                {id:0, type:1, content:null}, {id:1, type:1, content:null}, {id:2, type:1, content:null},
                {id:3, type:2, content:null}, // Ø§Ù„Ù†ÙˆØ¹ 2 Ù‡Ùˆ Ù‚Ù† Ø§Ù„Ø¯Ø¬Ø§Ø¬
                {id:4, type:0, content:null}, {id:5, type:0, content:null}
            ]
        };

        let currentTool = null;

        // === Ø§Ù„Ù…Ù†Ø·Ù‚ ===
        const Game = {
            init: function() {
                if(localStorage.getItem('HayDay_v2')) {
                    state = JSON.parse(localStorage.getItem('HayDay_v2'));
                }
                UI.renderGrid();
                UI.updateHeader();
                
                // Ø­Ù„Ù‚Ø© Ø§Ù„Ù†Ù…Ùˆ ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬
                setInterval(() => {
                    let changed = false;
                    state.grid.forEach(tile => {
                        if(tile.content && tile.content.status === 'growing') {
                            const duration = tile.type === 2 ? CONFIG.animals.chicken.time : CONFIG.crops[tile.content.type].time;
                            if(Date.now() - tile.content.startTime >= duration) {
                                tile.content.status = 'ready';
                                changed = true;
                            }
                        }
                    });
                    if(changed) UI.renderGrid();
                }, 1000);
            },

            save: function() { localStorage.setItem('HayDay_v2', JSON.stringify(state)); },

            onTileClick: function(index) {
                const tile = state.grid[index];

                // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø±Ø¶ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ© (Type 1) ---
                if (tile.type === 1) {
                    // Ø²Ø±Ø§Ø¹Ø©
                    if (!tile.content && currentTool && currentTool.startsWith('seed_')) {
                        const crop = currentTool.split('_')[1];
                        if (state.inventory[crop] > 0) {
                            state.inventory[crop]--;
                            tile.content = { type: crop, status: 'growing', startTime: Date.now() };
                            UI.playSound('plant');
                            UI.floatText(`-1 ${CONFIG.crops[crop].icon}`, index);
                        } else tg.showAlert("Ù„Ø§ ØªÙ…Ù„Ùƒ Ø¨Ø°ÙˆØ±Ø§Ù‹!");
                    }
                    // Ø­ØµØ§Ø¯
                    else if (tile.content && tile.content.status === 'ready') {
                        const crop = tile.content.type;
                        state.inventory[crop] += 2;
                        Game.addXp(CONFIG.crops[crop].xp);
                        tile.content = null;
                        UI.playSound('harvest');
                        UI.floatText(`+2 ${CONFIG.crops[crop].icon}`, index);
                    }
                }
                
                // --- Ù…Ù†Ø·Ù‚ Ù‚Ù† Ø§Ù„Ø¯Ø¬Ø§Ø¬ (Type 2) ---
                else if (tile.type === 2) {
                    // Ø¥Ø·Ø¹Ø§Ù… Ø§Ù„Ø¯Ø¬Ø§Ø¬ (Ø§Ø°Ø§ ÙƒØ§Ù† Ø¬Ø§Ø¦Ø¹Ø§Ù‹/ÙØ§Ø±ØºØ§Ù‹)
                    if (!tile.content) {
                        if(state.inventory['wheat'] >= 1) {
                            state.inventory['wheat']--;
                            // Ø§Ù„Ø¯Ø¬Ø§Ø¬ Ø§Ù„Ø¢Ù† ÙŠØ£ÙƒÙ„
                            tile.content = { type: 'chicken', status: 'growing', startTime: Date.now() }; 
                            UI.playSound('plant');
                            UI.floatText("-1 ğŸŒ¾", index);
                        } else {
                            tg.showAlert("Ø§Ù„Ø¯Ø¬Ø§Ø¬ Ø¬Ø§Ø¦Ø¹ ÙˆÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù‚Ù…Ø­ ğŸŒ¾!");
                        }
                    }
                    // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ¶
                    else if (tile.content.status === 'ready') {
                        state.inventory['egg']++;
                        Game.addXp(CONFIG.animals.chicken.xp);
                        tile.content = null; // ÙŠØ¹ÙˆØ¯ Ø§Ù„Ø¯Ø¬Ø§Ø¬ Ø¬Ø§Ø¦Ø¹Ø§Ù‹
                        UI.playSound('harvest');
                        UI.floatText("+1 ğŸ¥š", index);
                    }
                }

                Game.save();
                UI.renderGrid();
                UI.updateHeader();
            },

            addXp: function(amount) {
                state.xp += amount;
                if(state.xp >= state.maxXp) {
                    state.level++; state.xp = 0; state.maxXp *= 1.5;
                    tg.showAlert(`Ù…Ø¨Ø±ÙˆÙƒ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${state.level}! ğŸ‰`);
                }
            },
            
            buyPlot: function() {
                Game.expandGrid(1, 50);
            },
            
            buyCoop: function() {
                Game.expandGrid(2, 100);
            },

            expandGrid: function(type, cost) {
                if(state.coins >= cost) {
                    const grassIdx = state.grid.findIndex(t => t.type === 0);
                    if(grassIdx !== -1) {
                        state.coins -= cost;
                        state.grid[grassIdx].type = type;
                        Game.save(); UI.renderGrid(); UI.updateHeader();
                        tg.showAlert("ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!");
                    } else tg.showAlert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø©!");
                } else tg.showAlert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø°Ù‡Ø¨ ÙƒØ§ÙÙ!");
            }
        };

        // === ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ===
        const UI = {
            renderGrid: function() {
                const gridEl = document.getElementById('grid');
                gridEl.innerHTML = '';
                state.grid.forEach((tile, index) => {
                    const el = document.createElement('div');
                    // ØªØ­Ø¯ÙŠØ¯ Ø´ÙƒÙ„ Ø§Ù„Ø¨Ù„Ø§Ø·Ø© (Ø£Ø±Ø¶ØŒ Ø¹Ø´Ø¨ØŒ Ø£Ùˆ Ø¯Ø¬Ø§Ø¬)
                    let className = 'tile';
                    if(tile.type === 1) className += ' farmland';
                    if(tile.type === 2) className += ' coop';
                    el.className = className;
                    
                    el.onclick = () => Game.onTileClick(index);

                    if (tile.content) {
                        const isAnimal = tile.type === 2;
                        const info = isAnimal ? CONFIG.animals.chicken : CONFIG.crops[tile.content.type];
                        const icon = (isAnimal && tile.content.status === 'ready') ? 'ğŸ¥š' : info.icon;
                        
                        const sprite = document.createElement('div');
                        sprite.className = 'sprite';
                        sprite.innerText = icon;
                        
                        if(tile.content.status === 'growing') el.classList.add('growing');
                        else el.classList.add('ready');
                        
                        el.appendChild(sprite);
                    } else if (tile.type === 2) {
                        // Ø¹Ø±Ø¶ Ø¯Ø¬Ø§Ø¬Ø© ØµØºÙŠØ±Ø© Ø´ÙØ§ÙØ© Ù„ØªØ¯Ù„ Ø¹Ù„Ù‰ Ø£Ù† Ø§Ù„Ù…ÙƒØ§Ù† ÙØ§Ø±Øº ÙˆÙŠØ­ØªØ§Ø¬ Ø·Ø¹Ø§Ù…
                        const sprite = document.createElement('div');
                        sprite.className = 'sprite';
                        sprite.innerText = 'ğŸ”';
                        sprite.style.opacity = '0.3';
                        sprite.style.transform = 'rotateZ(45deg) rotateX(-60deg) scale(0.8)';
                        el.appendChild(sprite);
                    }
                    gridEl.appendChild(el);
                });
            },

            updateHeader: function() {
                document.getElementById('coins').innerText = Math.floor(state.coins);
                document.getElementById('level').innerText = state.level;
                document.getElementById('xp-bar').style.width = `${(state.xp / state.maxXp) * 100}%`;
                
                let seeds = 0;
                ['wheat','corn','carrot'].forEach(k => seeds += state.inventory[k] || 0);
                document.getElementById('silo-count').innerText = seeds;
                
                let prods = state.inventory['egg'] || 0;
                document.getElementById('barn-count').innerText = prods;
            },

            openModal: function(id) {
                document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
                document.getElementById(`modal-${id}`).style.display = 'flex';
                if(id === 'silo') UI.renderInventory('silo-grid', ['wheat','corn','carrot'], true);
                if(id === 'barn') UI.renderInventory('barn-grid', ['egg'], false);
            },
            
            renderInventory: function(containerId, items, isTool) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                items.forEach(key => {
                    if(state.inventory[key] > 0) {
                        const div = document.createElement('div');
                        div.className = 'tool-btn';
                        div.style.width = '60px'; div.style.height = '60px';
                        const icon = CONFIG.crops[key] ? CONFIG.crops[key].icon : 'ğŸ¥š';
                        div.innerHTML = `${icon}<span class="badge">${state.inventory[key]}</span>`;
                        if(isTool) {
                            div.onclick = () => {
                                UI.selectTool(`seed_${key}`, CONFIG.crops[key].name);
                                UI.closeAll();
                            };
                        }
                        container.appendChild(div);
                    }
                });
            },

            closeAll: function() { document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none'); },
            
            selectTool: function(id, name) {
                currentTool = id;
                document.getElementById('current-tool-display').style.display = 'block';
                document.getElementById('tool-name').innerText = name;
                setTimeout(() => { currentTool = null; document.getElementById('current-tool-display').style.display = 'none'; }, 5000);
            },

            floatText: function(text, index) {
                const floater = document.createElement('div');
                floater.className = 'floater'; floater.innerText = text;
                floater.style.left = '50%'; floater.style.top = '50%';
                document.body.appendChild(floater);
                setTimeout(() => floater.remove(), 1000);
            },
            
            playSound: function(type) { tg.HapticFeedback.impactOccurred('light'); }
        };

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-react-ui/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-btn'
        });

        Game.init();
    </script>
</body>
</html>
